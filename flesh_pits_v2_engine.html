
<!DOCTYPE html>
<html>
<head>
    <title>Flesh Pits - Advanced Combat + Choice Engine</title>
    <style>
        :root {
            --surface: #15151d;
            --surface-alt: #1b1b24;
            --border: #303040;
            --text: #eee;
            --muted: #bbb;
            --accent: #ff3b3f;
            --accent-2: #ff8a3b;
        }

        body {
            font-family: monospace;
            background: #0c0c0f;
            color: var(--text);
            padding: 20px;
            max-width: 1100px;
            margin: 0 auto 48px;
            line-height: 1.4;
        }

        h1, h2 {
            color: var(--accent);
            text-shadow: 0 0 8px rgba(255, 59, 63, 0.5);
            margin-top: 0;
        }

        .tagline {
            color: var(--muted);
            margin: 0 0 12px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            align-items: start;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.35);
            border-radius: 8px;
        }

        .pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: #222;
            border: 1px solid #444;
            margin-bottom: 6px;
            color: #ddd;
            letter-spacing: 0.5px;
        }

        .pill.status-peril {
            background: rgba(255, 59, 63, 0.12);
            border-color: #ff585c;
            color: #ffc3c5;
        }

        .pill.status-resolved {
            background: rgba(73, 212, 92, 0.12);
            border-color: #5ad66b;
            color: #c3f1c9;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin: 14px 0 4px;
        }

        button {
            background-color: #1e1e28;
            color: #fff;
            padding: 10px;
            border: 1px solid #555;
            cursor: pointer;
            transition: transform 0.05s ease, border-color 0.1s ease;
            border-radius: 6px;
        }

        button:hover {
            transform: translateY(-1px);
            border-color: var(--accent);
        }

        button:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        pre {
            background: #13131a;
            padding: 10px;
            border: 1px solid #2d2d39;
            white-space: pre-wrap;
            min-height: 80px;
            border-radius: 6px;
        }

        #log {
            max-height: 280px;
            overflow-y: auto;
        }

        .meter {
            background: var(--surface-alt);
            border: 1px solid #333;
            height: 12px;
            width: 100%;
            position: relative;
            margin-top: 6px;
        }

        .meter-fill {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            height: 100%;
            width: 100%;
        }

        .statline {
            margin: 6px 0 0;
            color: var(--muted);
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <h1>üß† Funnel of the Flesh Pits - V2 Engine</h1>

    <p class="tagline">An encounter-focused micro engine with combat, exploration, and creeping mutation.</p>

    <div class="grid">
        <div class="card">
            <h2>Peasant</h2>
            <pre id="peasantStats"></pre>
        </div>

        <div class="card">
            <h2>Room: Tendril Garden</h2>
            <pre id="roomFlavor">
Vines twitch. The air pulses with spores. A Maggot Lion prowls here.

What will you do?
            </pre>
            <div class="pill" id="turnIndicator">Turn 1</div>
            <div class="pill" id="stateIndicator">In Peril</div>
        </div>

        <div class="card">
            <h2>Foe</h2>
            <pre id="enemyStats"></pre>
        </div>
    </div>

    <div class="actions">
        <button id="fightBtn" onclick="fight()">‚öîÔ∏è Fight</button>
        <button id="fleeBtn" onclick="flee()">üèÉ‚Äç‚ôÇÔ∏è Flee</button>
        <button id="searchBtn" onclick="search()">üîç Search</button>
        <button id="mutateBtn" onclick="mutate()">üß¨ Mutate</button>
        <button id="restBtn" onclick="rest()">‚õ∫ Rest</button>
        <button id="resetBtn" onclick="resetGame()">üîÑ Reset Encounter</button>
    </div>

    <h2>üìú Log</h2>
    <pre id="log">Choose an action...</pre>

    <script>
        const mutationEffects = {
            "Extra Eye": "+1 perception",
            "Glowing Skin": "-1 stealth",
            "Rooted Toes": "+1 resist knockback",
            "Bioluminescent Veins": "+1 light radius",
            "Bone Mask": "+1 to frighten checks",
            "Spore Halo": "Allies gain +1 morale",
            "Chitin Knuckles": "+1 damage in melee"
        };

        const initialPeasant = {
            name: "Peasant 1",
            hp: 6,
            maxHp: 6,
            str: 12,
            agi: 10,
            mutation: "Extra Eye",
            item: "Gland Knife",
            alive: true
        };

        const initialEnemy = {
            name: "Maggot Lion",
            hp: 8,
            maxHp: 8,
            ac: 11,
            damage: () => Math.floor(Math.random() * 4) + 1
        };

        let peasant = { ...initialPeasant };
        let enemy = { ...initialEnemy };
        let turn = 1;
        let escaped = false;

        function abilityMod(score) {
            return Math.floor((score - 10) / 2);
        }

        function rollD20(mod = 0) {
            const die = Math.floor(Math.random() * 20) + 1;
            return { die, mod, total: die + mod };
        }

        function formatRoll({ die, mod, total }) {
            const modText = mod === 0 ? "" : ` ${mod > 0 ? "+" : ""}${mod}`;
            return `${die}${modText} ‚áí ${total}`;
        }

        function toMeter(current, max) {
            const pct = Math.max(0, Math.min(1, current / max));
            const bar = "‚ñà".repeat(Math.round(pct * 20)).padEnd(20, "‚ñí");
            return `${bar} ${current}/${max}`;
        }

        function describeWound(current, max) {
            const pct = current / max;
            if (pct === 0) return "slain";
            if (pct < 0.25) return "near death";
            if (pct < 0.5) return "wounded";
            if (pct < 0.9) return "scratched";
            return "fresh";
        }

        function updateStatusPills(stateText) {
            const indicator = document.getElementById("stateIndicator");
            indicator.innerText = stateText;
            indicator.classList.remove("status-peril", "status-resolved");
            indicator.classList.add(stateText === "In Peril" ? "status-peril" : "status-resolved");
        }

        function updateStats() {
            const statBlock = `Name: ${peasant.name}
HP: ${toMeter(peasant.hp, peasant.maxHp)} (${describeWound(peasant.hp, peasant.maxHp)})
STR: ${peasant.str}
AGI: ${peasant.agi}
Mutation: ${peasant.mutation} (${mutationEffects[peasant.mutation]})
Item: ${peasant.item}
Status: ${peasant.alive ? (escaped ? "Escaped" : "In the fight") : "Dead"}`;
            document.getElementById("peasantStats").innerText = statBlock;

            const enemyBlock = `Foe: ${enemy.name}
HP: ${toMeter(enemy.hp, enemy.maxHp)} (${describeWound(enemy.hp, enemy.maxHp)})
AC: ${enemy.ac}
Threat: gore-slick tendrils and a clacking maw.`;
            document.getElementById("enemyStats").innerText = enemyBlock;

            document.getElementById("turnIndicator").innerText = `Turn ${turn}`;
            const inPeril = peasant.alive && !escaped && enemy.hp > 0;
            updateStatusPills(inPeril ? "In Peril" : "Resolved");
            toggleActions(!inPeril);
        }

        function log(text) {
            const logBox = document.getElementById("log");
            logBox.innerText = `[Turn ${turn}] ${text}\n\n` + logBox.innerText;
        }

        function toggleActions(disabled) {
            document.querySelectorAll(".actions button").forEach(btn => {
                if (btn.id === "resetBtn") return;
                btn.disabled = disabled;
            });
        }

        function fight() {
            if (!canAct()) return;
            const attackRoll = rollD20(abilityMod(peasant.str));
            const mutationBonus = peasant.mutation === "Chitin Knuckles" ? 1 : 0;
            const baseDamage = Math.floor(Math.random() * 6) + 1 + mutationBonus;
            const isCrit = attackRoll.die === 20;
            const fumbled = attackRoll.die === 1;

            log(`You attack with a d20 roll ${formatRoll(attackRoll)} vs AC ${enemy.ac}.`);

            if (attackRoll.total >= enemy.ac || isCrit) {
                const dmg = isCrit ? baseDamage * 2 : baseDamage;
                enemy.hp = Math.max(0, enemy.hp - dmg);
                log(`Hit! ${isCrit ? "Critical! " : ""}You deal ${dmg} damage. Enemy HP: ${enemy.hp}.`);
                if (enemy.hp <= 0) {
                    resolve(`You slay the ${enemy.name}!`);
                } else {
                    enemyStrike(false, isCrit ? "staggered from your blow" : "bristles at the wound");
                }
            } else {
                log(fumbled ? "You fumble and expose your flank!" : "Miss! The enemy prepares to strike...");
                enemyStrike(fumbled);
            }
            turn++;
            updateStats();
        }

        function flee() {
            if (!canAct()) return;
            const roll = rollD20(abilityMod(peasant.agi));
            log(`You attempt to flee... d20: ${formatRoll(roll)} vs DC 12.`);
            const autoSuccess = roll.die === 20;
            const success = autoSuccess || roll.total >= 12;

            if (success) {
                escaped = true;
                resolve(autoSuccess ? "You vanish into the spores with impossible speed!" : "You escape the room safely!");
            } else {
                log(roll.die === 1 ? "You slip! The Maggot Lion pounces." : "You fail to flee!");
                enemyStrike(roll.die === 1);
            }
            turn++;
            updateStats();
        }

        function search() {
            if (!canAct()) return;
            const roll = Math.random();
            if (roll < 0.4) {
                const reward = ["Spore Bomb", "Flesh Key", "Healing Salve"][Math.floor(Math.random() * 3)];
                log(`You search the room... and find a ${reward}!`);
                if (reward === "Healing Salve" && peasant.hp < peasant.maxHp) {
                    const healed = Math.min(peasant.maxHp - peasant.hp, 3);
                    peasant.hp += healed;
                    log(`You apply the salve and recover ${healed} HP.`);
                } else if (reward !== "Healing Salve") {
                    // Replace current item to highlight the new find.
                    peasant.item = reward;
                    log(`You pocket the ${reward}, swapping out your old tool.`);
                }
            } else if (roll < 0.6) {
                log("Your rummaging disturbs a nest of spores. They burn your lungs!");
                peasant.hp = Math.max(0, peasant.hp - 2);
                if (peasant.hp === 0) {
                    peasant.alive = false;
                    resolve("You choke and collapse among the tendrils.");
                }
            } else {
                log("You find nothing but rot.");
                enemyStrike();
            }
            turn++;
            updateStats();
        }

        function mutate() {
            if (!canAct()) return;
            const availableMutations = Object.keys(mutationEffects);
            const newMut = availableMutations[Math.floor(Math.random() * availableMutations.length)];
            const previousMutation = peasant.mutation;
            peasant.mutation = newMut;
            const label = newMut === previousMutation ? "Your mutation intensifies" : "New Mutation";
            log(`You absorb spores... ${label}: ${newMut} (${mutationEffects[newMut]})`);
            if (newMut === "Glowing Skin") {
                log("The Maggot Lion notices the glow and lunges!");
                enemyStrike();
            }
            turn++;
            updateStats();
        }

        function enemyStrike(enraged = false, note = "") {
            // Enraged strikes add a point of damage when the peasant blunders or shines brightly.
            const base = enemy.damage();
            const dmg = enraged ? base + 1 : base;
            peasant.hp -= dmg;
            if (peasant.hp <= 0) {
                peasant.alive = false;
                peasant.hp = 0;
                resolve(`The ${enemy.name} mauls you for ${dmg} damage. You die.`);
            } else {
                const fury = enraged ? " with vicious force" : "";
                const extra = note ? ` (${note}).` : "";
                log(`The ${enemy.name} strikes${fury} for ${dmg} damage. You have ${peasant.hp} HP left.${extra}`);
            }
        }

        function rest() {
            if (!canAct()) return;
            if (enemy.hp > 0) {
                log("You try to catch your breath under the watchful eyes of the Maggot Lion...");
                enemyStrike();
            } else {
                const healed = Math.min(peasant.maxHp - peasant.hp, 2);
                peasant.hp += healed;
                log(healed === 0 ? "You are already at full strength." : `You bind wounds and recover ${healed} HP.`);
            }
            turn++;
            updateStats();
        }

        function resolve(message) {
            log(message);
            toggleActions(true);
        }

        function canAct() {
            return peasant.alive && enemy.hp > 0 && !escaped;
        }

        function resetGame() {
            peasant = { ...initialPeasant };
            enemy = { ...initialEnemy };
            turn = 1;
            escaped = false;
            document.getElementById("log").innerText = "Choose an action...";
            document.getElementById("roomFlavor").innerText = `
Vines twitch. The air pulses with spores. A ${enemy.name} prowls here.

What will you do?
            `;
            toggleActions(false);
            updateStats();
        }

        updateStats();
    </script>
</body>
</html>
